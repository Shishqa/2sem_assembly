## Лабораторная работа "оптимизация хеш-таблицы"

### Этапы:

1. Исследование равномерности хеш-функций
2. Оптимизация хеш-таблицы

### 1. Исследование равномерности хеш-функций

Было рассмотрено несколько некриптографических хеш-функций различной степени сложности. На вход программы поступал текст книги ''Война и Мир'', каждое слово которого добавлялось в хеш-таблицу. Ниже приведены метрики для некоторых рассмотренных хеш-функций.

1. Хеш равен ascii-коду первого символа в слове
![image](https://user-images.githubusercontent.com/53887365/82325726-e6728400-9a05-11ea-8743-f8ee5a1c56cb.png)

2. Хеш равен длине слова

![image](https://user-images.githubusercontent.com/53887365/82325849-17eb4f80-9a06-11ea-96e0-5b3748d3f570.png)

3. Murmurhash3
![image](https://user-images.githubusercontent.com/53887365/82325429-6fd58680-9a05-11ea-8122-1c97cf30ba9c.png)

4. CRC32
![image](https://user-images.githubusercontent.com/53887365/82327857-3a329c80-9a09-11ea-81e7-e62b63f8bb82.png)

Наиболее приятными распределениями обладают функции Murmurhash3 и CRC32. В дальнейшем хеш будет считаться при помощи этих функций.

### 2. Оптимизация хеш таблицы

Тест производительности производится следующим образом: в хеш-таблицу также загружается текст книги ''Война и Мир'', затем выполняется поиск некоторых слов в хеш-таблице достаточно большое количество раз, чтобы затмить расход производительности на наполнение таблицы. Вывод и ввод при поиске не производится, так как эти операции значительно 'тяжелее', чем поиск.

#### Тест производительности на изначальном этапе
![image](https://user-images.githubusercontent.com/53887365/82326002-5c76eb00-9a06-11ea-927f-7277d7997a79.png)
![image](https://user-images.githubusercontent.com/53887365/82326260-becfeb80-9a06-11ea-86db-f949774afc80.png)

Как видно из теста, наиболее затратными являются функции вычисления хеша, функция сравнения строк и функция поиска по цепочке. Было принято решение оптимизировать именно эти функции.

Для сравнения приведен тест производительности std::unordered_map c теми же функциями вычисления хеша и сравнения строк:
![image](https://user-images.githubusercontent.com/53887365/82326068-787a8c80-9a06-11ea-8f9c-56db7b690c14.png)

#### Основные этапы оптимизации
1. Много времени занимает 'обрезание' хеша по модулю размера таблицы, так как там выполняется деление. Было решено добавить проверку на то, является ли размер таблицы степенью двойки, так как в случае степенью двойки деление может быть выполнено с помощью побитового И. Размер таблицы был заменён на степень двойки.
2. С помощью ассемблерных вставок был оптимизирован код вычисления Murmurhash3.
3. Murmurhash3 был заменён на хеш CRC32, вычисление которого поддерживается на уровне ассемблерных инструкций.
4. Сравнение строк сделано инлайновым.
5. Реализовано с помощью sse-инструкций. Однако, был замечен спад производительности.

Все программы компилировались с флагом `-O0`

| Этап   | 0       | 1       | 2       | 3       | 4       | 5       |
| ------ | ------- | ------- | ------- | ------- | ------- | ------- |
| Время  | 7.8 сек | 5.7 сек | 5.1 сек | 4.4 сек | 4.0 сек | 4.4 сек |

Индекс ускорения: `1.95`

![image](https://user-images.githubusercontent.com/53887365/82326359-e3c45e80-9a06-11ea-927d-2ba387709263.png)
![image](https://user-images.githubusercontent.com/53887365/82326437-06ef0e00-9a07-11ea-9376-170d933f3652.png)

Так как на этом этапе основную часть производительности съедают обращения к памяти, я решил проверить, как будут соотноститься значения производительности с флагом компиляции `-O1`, который убирает большинство обращений к памяти.

| Этап   | 0       | 4       | 
| ------ | ------- | ------- | 
| Время  | 2.5 сек | 1.2 сек |

Индекс ускорения: `2.08`
